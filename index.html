<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tausug-English Dictionary & Translator</title>
<style>
body { font-family: Arial, sans-serif; background: #f0f4f8; padding: 20px; }
h1 { text-align: center; margin-bottom: 20px; color: #333; }
form, .controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px; }
input[type="text"], input[type="email"], input[type="password"], input[type="file"], button { padding: 8px; font-size: 14px; border-radius: 5px; border: 1px solid #ccc; }
button { cursor: pointer; background: #007bff; color: #fff; border: none; transition: background 0.3s; }
button:hover { background: #0056b3; }
ul { list-style: none; padding: 0; max-width: 700px; margin: auto; }
li { background: #fff; padding: 10px; margin-bottom: 5px; border-radius: 8px; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
li span { flex-grow: 1; cursor: pointer; }
li input { flex-grow: 1; padding: 4px 6px; font-size: 14px; }
.notification { text-align: center; margin-bottom: 15px; color: green; font-weight: bold; }
.translation-box { text-align: center; font-size: 16px; margin-bottom: 20px; color: #555; }
.auth { text-align: center; margin-bottom: 20px; }
.hidden { display: none; }
.suggestions { max-width: 700px; margin: auto; text-align: left; background: #fff; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
.suggestions div { padding: 6px 10px; cursor: pointer; }
.suggestions div:hover { background: #e0e0e0; }
</style>
</head>
<body>

<h1>Tausug-English Dictionary & Translator</h1>
<div class="notification" id="notification"></div>

<div class="auth" id="authDiv">
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button id="loginBtn">Login</button>
  <button id="signupBtn">Sign Up</button>
  <button id="logoutBtn" class="hidden">Logout</button>
  <div id="userInfo"></div>
</div>

<form id="addForm" class="hidden">
  <input type="text" id="tausug" placeholder="Tausug word" required>
  <input type="text" id="english" placeholder="English meaning" required>
  <button type="submit">Add / Update Word</button>
</form>

<div class="controls">
  <input type="text" id="searchInput" placeholder="Search Tausug or English" autocomplete="off">
  <input type="file" id="importFile" accept=".json" class="hidden">
  <button id="importBtn" class="hidden">Import JSON</button>
  <button id="exportBtn" class="hidden">Export JSON</button>
</div>

<div class="suggestions hidden" id="suggestions"></div>
<div class="translation-box" id="translationBox">Type a word above to see translation</div>

<ul id="wordsList"></ul>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, doc, deleteDoc, updateDoc, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-firestore.js";

// Firebase config placeholder
const firebaseConfig = {
  apiKey: "your-api-key",
  authDomain: "your-project.firebaseapp.com",
  projectId: "your-project-id",
  storageBucket: "your-project.appspot.com",
  messagingSenderId: "123456789",
  appId: "your-app-id"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
window.auth = auth;
window.db = db;

// DOM elements
const addForm = document.getElementById('addForm');
const tausugInput = document.getElementById('tausug');
const englishInput = document.getElementById('english');
const wordsList = document.getElementById('wordsList');
const searchInput = document.getElementById('searchInput');
const importBtn = document.getElementById('importBtn');
const exportBtn = document.getElementById('exportBtn');
const importFile = document.getElementById('importFile');
const notification = document.getElementById('notification');
const translationBox = document.getElementById('translationBox');
const suggestionsDiv = document.getElementById('suggestions');

const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const loginBtn = document.getElementById('loginBtn');
const signupBtn = document.getElementById('signupBtn');
const logoutBtn = document.getElementById('logoutBtn');
const userInfo = document.getElementById('userInfo');

let allWords = [];
const wordsCollection = collection(db, "tausugDictionary");

function showNotification(msg, color="green") {
  notification.textContent = msg;
  notification.style.color = color;
  setTimeout(() => notification.textContent = '', 3000);
}

// Render word with inline auto-save
function renderWord(docData) {
  const li = document.createElement('li');
  li.setAttribute('data-id', docData.id);

  const tausugSpan = document.createElement('span');
  tausugSpan.textContent = docData.tausug;
  tausugSpan.contentEditable = auth.currentUser ? true : false;

  const englishSpan = document.createElement('span');
  englishSpan.textContent = docData.english;
  englishSpan.contentEditable = auth.currentUser ? true : false;

  if(auth.currentUser){
    tausugSpan.addEventListener('blur', async () => {
      const newT = tausugSpan.textContent.trim();
      if(newT && newT !== docData.tausug){
        const docRef = doc(db, "tausugDictionary", docData.id);
        await updateDoc(docRef, { tausug: newT });
        showNotification("Tausug word updated");
      }
    });

    englishSpan.addEventListener('blur', async () => {
      const newE = englishSpan.textContent.trim();
      if(newE && newE !== docData.english){
        const docRef = doc(db, "tausugDictionary", docData.id);
        await updateDoc(docRef, { english: newE });
        showNotification("English word updated");
      }
    });
  }

  li.appendChild(tausugSpan);
  li.appendChild(englishSpan);

  if(auth.currentUser){
    const deleteBtn = document.createElement('button'); 
    deleteBtn.textContent = 'Delete';
    deleteBtn.onclick = async () => {
      const docRef = doc(db, "tausugDictionary", docData.id);
      await deleteDoc(docRef);
      showNotification("Word deleted", "red");
    };
    li.appendChild(deleteBtn);
  }

  wordsList.appendChild(li);
}

// Real-time sync
onSnapshot(query(wordsCollection, orderBy('tausug')), snapshot => {
  wordsList.innerHTML = '';
  allWords = [];
  snapshot.forEach(docSnap => {
    const data = { id: docSnap.id, ...docSnap.data() };
    renderWord(data);
    allWords.push(data);
  });
});

// Add / update word
addForm.addEventListener('submit', async e => {
  e.preventDefault();
  if (!auth.currentUser) return alert("Login first");
  const tausug = tausugInput.value.trim();
  const english = englishInput.value.trim();
  if(!tausug || !english) return;

  const q = query(wordsCollection, where('tausug', '==', tausug));
  const querySnapshot = await getDocs(q);
  if(!querySnapshot.empty){
    const docRef = doc(db, "tausugDictionary", querySnapshot.docs[0].id);
    await updateDoc(docRef, { english });
    showNotification("Word updated");
  } else {
    await addDoc(wordsCollection, { tausug, english });
    showNotification("Word added");
  }
  addForm.reset();
});

// Instant search suggestions
searchInput.addEventListener('input', () => {
  const term = searchInput.value.toLowerCase();
  suggestionsDiv.innerHTML = '';
  if(!term){
    suggestionsDiv.classList.add('hidden');
    translationBox.textContent = "Type a word above to see translation";
    Array.from(wordsList.children).forEach(li => li.style.display='');
    return;
  }

  const matches = allWords.filter(w => w.tausug.toLowerCase().includes(term) || w.english.toLowerCase().includes(term));
  matches.slice(0, 10).forEach(w => {
    const div = document.createElement('div');
    div.textContent = `${w.tausug} = ${w.english}`;
    div.onclick = () => {
      searchInput.value = w.tausug;
      translationBox.textContent = `${w.tausug} = ${w.english}`;
      suggestionsDiv.classList.add('hidden');
    };
    suggestionsDiv.appendChild(div);
  });
  suggestionsDiv.classList.toggle('hidden', matches.length===0);

  Array.from(wordsList.children).forEach(li => {
    const text = li.children[0].textContent.toLowerCase() + li.children[1].textContent.toLowerCase();
    li.style.display = text.includes(term) ? '' : 'none';
  });

  const found = allWords.find(w => w.tausug.toLowerCase() === term || w.english.toLowerCase() === term);
  translationBox.textContent = found ? `${found.tausug} = ${found.english}` : "No translation found";
});

// Export / Import JSON
exportBtn.addEventListener('click', async () => {
  const snapshot = await getDocs(wordsCollection);
  const data = snapshot.docs.map(docSnap => docSnap.data());
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'tausug_dictionary.json'; a.click();
  URL.revokeObjectURL(url);
  showNotification("JSON exported");
});

importBtn.addEventListener('click', () => {
  if(!auth.currentUser) return alert("Login first");
  const file = importFile.files[0];
  if(!file) return alert("Select a JSON file");
  const reader = new FileReader();
  reader.onload = async e => {
    try {
      const data = JSON.parse(e.target.result);
      for(const word of data){
        if(word.tausug && word.english){
          const q = query(wordsCollection, where('tausug','==', word.tausug));
          const querySnapshot = await getDocs(q);
          if(!querySnapshot.empty){
            const docRef = doc(db,"tausugDictionary", querySnapshot.docs[0].id);
            await updateDoc(docRef, { english: word.english });
          } else {
            await addDoc(wordsCollection, { tausug: word.tausug, english: word.english });
          }
        }
      }
      showNotification("JSON imported");
    } catch(err){ alert("Invalid JSON"); }
  };
  reader.readAsText(file);
});

// Auth
signupBtn.addEventListener('click', async () => {
  try { await createUserWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value.trim()); showNotification("Signed up"); } 
  catch(err){ showNotification(err.message,"red"); }
});
loginBtn.addEventListener('click', async () => {
  try { await signInWithEmailAndPassword(auth, emailInput.value.trim(), passwordInput.value.trim()); showNotification("Logged in"); } 
  catch(err){ showNotification(err.message,"red"); }
});
logoutBtn.addEventListener('click', async () => { await signOut(auth); });

onAuthStateChanged(auth, user => {
  if(user){
    addForm.classList.remove('hidden');
    logoutBtn.classList.remove('hidden');
    loginBtn.classList.add('hidden');
    signupBtn.classList.add('hidden');
    importBtn.classList.remove('hidden');
    exportBtn.classList.remove('hidden');
    importFile.classList.remove('hidden');
    userInfo.textContent = "Logged in as: "+user.email;
  } else {
    addForm.classList.add('hidden');
    logoutBtn.classList.add('hidden');
    loginBtn.classList.remove('hidden');
    signupBtn.classList.remove('hidden');
    importBtn.classList.add('hidden');
    exportBtn.classList.add('hidden');
    importFile.classList.add('hidden');
    userInfo.textContent = "";
  }
});
</script>
</body>
</html>
